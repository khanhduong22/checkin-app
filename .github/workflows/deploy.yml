name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}       # IP của VPS
          username: ${{ secrets.VPS_USER }}   # Tên đăng nhập (thường là root)
          password: ${{ secrets.VPS_PASSWORD }} # Mật khẩu VPS
          port: 22
          script: |
            # Di chuyển vào thư mục dự án
            cd checkin-app
            
            # Lưu tạm các thay đổi trên server (như file data checkins.json mới)
            git stash
            
            # Lấy code mới nhất về
            git pull origin main --rebase
            
            # Áp dụng lại các thay đổi data cũ (nếu có conflict thì ưu tiên server)
            git stash pop || echo "No local changes to restore or conflict auto-resolved"
            
            # Cài đặt view dependencies mới nếu có
            npm install
            
            # Restart lại app với PM2 để áp dụng thay đổi
            pm2 restart attendance-app || pm2 start app.js --name "attendance-app"
            
            echo "Deployment successful!"
